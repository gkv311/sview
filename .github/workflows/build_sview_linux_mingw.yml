name: Build (Linux/MinGW)
on:
  workflow_call:

env:
  TOOLCHAIN_PREFIX: x86_64-w64-mingw32
  TOOLCHAIN_TEXT: |
    set(CMAKE_SYSTEM_NAME Windows)
    set(CMAKE_C_COMPILER   x86_64-w64-mingw32-gcc-posix)
    set(CMAKE_CXX_COMPILER x86_64-w64-mingw32-g++-posix)
    set(CMAKE_RC_COMPILER  x86_64-w64-mingw32-windres)
    set(CMAKE_FIND_ROOT_PATH /usr/x86_64-w64-mingw32)
    set(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)
    set(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)
    set(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)
  FREETYPE_REF: 'VER-2-14-1'
  FFMPEG_REF:   'n8.0.1'
  OPENAL_REF:   '1.25.1'
  OPENVR_REF:   'v2.5.1'
  OPENJPEG_REF: 'v2.5.4'
  DAV1_REF:     '1.5.3'
  LIBJXL_REF:   'v0.11.1'
  CACHE_REV:    'cache1'

jobs:
  build-lin-mingw-freetype:
    runs-on: ubuntu-24.04
    steps:
    - uses: actions/cache@v5
      id: cache
      with:
        path: freetype-install
        key: freetype-windows-x64-mingw-${{ env.FREETYPE_REF }}-${{ env.CACHE_REV }}
    - name: Clone Tree
      if: steps.cache.outputs.cache-hit != 'true'
      uses: actions/checkout@v6
      with:
        path: freetype.git
        repository: freetype/freetype
        ref: ${{ env.FREETYPE_REF }}
        fetch-depth: 1
    - name: Install Dependencies
      if: steps.cache.outputs.cache-hit != 'true'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          g++ cmake ninja-build libz-mingw-w64-dev \
          mingw-w64-common mingw-w64-tools binutils-mingw-w64-x86-64 \
          g++-mingw-w64-x86-64-posix gcc-mingw-w64-x86-64-posix
        ${TOOLCHAIN_PREFIX}-g++ --version
    - name: Configure project
      if: steps.cache.outputs.cache-hit != 'true'
      env:
        FREETYPE_CONFIG: |
          set(BUILD_SHARED_LIBS ON  CACHE BOOL "")
          set(FT_WITH_ZLIB      ON  CACHE BOOL "")
          set(FT_WITH_BZIP2     OFF CACHE BOOL "")
          set(FT_WITH_PNG       OFF CACHE BOOL "")
          set(FT_WITH_HARFBUZZ  OFF CACHE BOOL "")
          set(FT_WITH_BROTLI    OFF CACHE BOOL "")
          set(CMAKE_DISABLE_FIND_PACKAGE_ZLIB      OFF  CACHE BOOL "")
          set(CMAKE_DISABLE_FIND_PACKAGE_BZip2     TRUE CACHE BOOL "")
          set(CMAKE_DISABLE_FIND_PACKAGE_PNG       TRUE CACHE BOOL "")
          set(CMAKE_DISABLE_FIND_PACKAGE_HarfBuzz  TRUE CACHE BOOL "")
          set(CMAKE_DISABLE_FIND_PACKAGE_BrotliDec TRUE CACHE BOOL "")
          ${{ env.TOOLCHAIN_TEXT }}
          set(CMAKE_BUILD_TYPE Release)
          set(CMAKE_INSTALL_PREFIX "${CMAKE_CURRENT_LIST_DIR}/freetype-install" CACHE PATH "")
      run: |
        echo "${FREETYPE_CONFIG}" | tee ./freetype-make.cmake
        cmake -S ./freetype.git -B ./freetype-make -G Ninja -D CMAKE_TOOLCHAIN_FILE="$PWD/freetype-make.cmake"
    - name: Build project
      if: steps.cache.outputs.cache-hit != 'true'
      run: cmake --build ./freetype-make
    - name: Install build
      if: steps.cache.outputs.cache-hit != 'true'
      run: |
        cmake --install ./freetype-make --prefix ./freetype-install
        cp -f "./freetype.git/docs/FTL.TXT"   "./freetype-install/"
        cp -f "./freetype.git/docs/GPLv2.TXT" "./freetype-install/"
        cp -f "./freetype.git/docs/CHANGES"   "./freetype-install/"
        cp -f "./freetype.git/docs/README"    "./freetype-install/"
        cp -f "./freetype.git/LICENSE.TXT"    "./freetype-install/"
    - name: Upload build
      uses: actions/upload-artifact@v4
      with:
        name: freetype-windows-x64-mingw
        path: freetype-install
        if-no-files-found: error

  build-lin-mingw-openal:
    runs-on: ubuntu-24.04
    steps:
    - uses: actions/cache@v5
      id: cache
      with:
        path: openal-install
        key: openal-windows-x64-mingw-${{ env.OPENAL_REF }}-${{ env.CACHE_REV }}
    - name: Clone Tree
      if: steps.cache.outputs.cache-hit != 'true'
      uses: actions/checkout@v6
      with:
        path: openal.git
        repository: kcat/openal-soft
        ref: ${{ env.OPENAL_REF }}
        fetch-depth: 1
    - name: Install Dependencies
      if: steps.cache.outputs.cache-hit != 'true'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          g++ cmake ninja-build \
          mingw-w64-common mingw-w64-tools binutils-mingw-w64-x86-64 \
          g++-mingw-w64-x86-64-posix gcc-mingw-w64-x86-64-posix
        ${TOOLCHAIN_PREFIX}-g++ --version
    - name: Configure project
      if: steps.cache.outputs.cache-hit != 'true'
      env:
        OPENAL_CONFIG: |
          set(ALSOFT_EXAMPLES         OFF CACHE BOOL "")
          set(ALSOFT_TESTS            OFF CACHE BOOL "")
          set(ALSOFT_UTILS             ON CACHE BOOL "")
          set(ALSOFT_BUILD_ROUTER     OFF CACHE BOOL "")
          set(ALSOFT_REQUIRE_WINMM     ON CACHE BOOL "")
          set(ALSOFT_REQUIRE_DSOUND    ON CACHE BOOL "")
          set(ALSOFT_REQUIRE_WASAPI    ON CACHE BOOL "")
          set(ALSOFT_STATIC_LIBGCC     ON CACHE BOOL "")
          set(ALSOFT_STATIC_STDCXX     ON CACHE BOOL "")
          set(ALSOFT_STATIC_WINPTHREAD ON CACHE BOOL "")
          ${{ env.TOOLCHAIN_TEXT }}
          set(CMAKE_BUILD_TYPE Release)
          set(CMAKE_INSTALL_PREFIX "${CMAKE_CURRENT_LIST_DIR}/openal-install" CACHE PATH "")
      run: |
        echo "${OPENAL_CONFIG}" | tee ./openal-make.cmake
        cmake -S ./openal.git -B ./openal-make -G Ninja -D CMAKE_TOOLCHAIN_FILE="$PWD/openal-make.cmake"
    - name: Build project
      if: steps.cache.outputs.cache-hit != 'true'
      run: cmake --build ./openal-make
    - name: Install build
      if: steps.cache.outputs.cache-hit != 'true'
      run: |
        cmake --install ./openal-make --prefix ./openal-install
        cp -f "./openal.git/COPYING"   "./openal-install/"
        cp -f "./openal.git/README.md" "./openal-install/"
    - name: Upload build
      uses: actions/upload-artifact@v4
      with:
        name: openal-windows-x64-mingw
        path: openal-install
        if-no-files-found: error

  build-lin-mingw-openvr:
    runs-on: ubuntu-24.04
    steps:
    - uses: actions/cache@v5
      id: cache
      with:
        path: openvr-install
        key: openvr-windows-x64-mingw-${{ env.OPENVR_REF }}-${{ env.CACHE_REV }}
    - name: Clone Tree
      if: steps.cache.outputs.cache-hit != 'true'
      uses: actions/checkout@v6
      with:
        path: openvr.git
        repository: ValveSoftware/openvr
        ref: ${{ env.OPENVR_REF }}
        fetch-depth: 1
    - name: Clone scripts
      if: steps.cache.outputs.cache-hit != 'true'
      uses: actions/checkout@v6
      with:
        path: sview.git
        fetch-depth: 1
        sparse-checkout: '3rdparty/openvr'
        sparse-checkout-cone-mode: false
    - name: Install Dependencies
      if: steps.cache.outputs.cache-hit != 'true'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          g++ cmake ninja-build python3 \
          mingw-w64-common mingw-w64-tools binutils-mingw-w64-x86-64 \
          g++-mingw-w64-x86-64-posix gcc-mingw-w64-x86-64-posix
        ${TOOLCHAIN_PREFIX}-g++ --version
    - name: Configure project
      if: steps.cache.outputs.cache-hit != 'true'
      env:
        OPENVR_CONFIG: |
          set(BUILD_SHARED ON  CACHE BOOL "")
          set(USE_LIBCXX   OFF CACHE BOOL "")
          # workaround for MinGW
          set(CMAKE_C_FLAGS   "-DWIN32")
          set(CMAKE_CXX_FLAGS "-DWIN32")
          ${{ env.TOOLCHAIN_TEXT }}
          set(CMAKE_BUILD_TYPE Release)
          set(CMAKE_INSTALL_PREFIX "${CMAKE_CURRENT_LIST_DIR}/openvr-install" CACHE PATH "")
      run: |
        echo "${OPENVR_CONFIG}" | tee ./openvr-make.cmake
        cmake -S ./openvr.git -B ./openvr-make -G Ninja -D CMAKE_TOOLCHAIN_FILE="$PWD/openvr-make.cmake"
    - name: Build project
      if: steps.cache.outputs.cache-hit != 'true'
      run: cmake --build ./openvr-make
    - name: Install build
      if: steps.cache.outputs.cache-hit != 'true'
      run: |
        cmake --install ./openvr-make --prefix ./openvr-install
        cp -f ./openvr.git/LICENSE   ./openvr-install/
        cp -f ./openvr.git/README.md ./openvr-install/
        mv -f ./openvr-install/include/openvr/*.h        ./openvr-install/include/
        cp -f ./openvr-install/lib/libopenvr_api64.dll.a ./openvr-install/lib/libopenvr_api.dll.a
        mkdir -p "./openvr-install/bin"
        mv -f ./openvr-install/lib/libopenvr_api64.dll   ./openvr-install/bin/
        python ./sview.git/3rdparty/openvr/cxx_header_generator.py -d ./openvr-install/include/
    - name: Upload build
      uses: actions/upload-artifact@v4
      with:
        name: openvr-windows-x64-mingw
        path: openvr-install
        if-no-files-found: error

  build-lin-mingw-libjxl:
    runs-on: ubuntu-24.04
    steps:
    - uses: actions/cache@v5
      id: cache
      with:
        path: libjxl-install
        key: libjxl-windows-x64-mingw-${{ env.LIBJXL_REF }}-${{ env.CACHE_REV }}
    - name: Clone Tree
      if: steps.cache.outputs.cache-hit != 'true'
      uses: actions/checkout@v6
      with:
        path: libjxl.git
        repository: libjxl/libjxl
        ref: ${{ env.LIBJXL_REF }}
        fetch-depth: 1
        submodules: 'true'
    - name: Install Dependencies
      if: steps.cache.outputs.cache-hit != 'true'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          g++ cmake ninja-build \
          mingw-w64-common mingw-w64-tools binutils-mingw-w64-x86-64 \
          g++-mingw-w64-x86-64-posix gcc-mingw-w64-x86-64-posix
        ${TOOLCHAIN_PREFIX}-g++ --version
    - name: Configure project
      if: steps.cache.outputs.cache-hit != 'true'
      env:
        LIBJXL_CONFIG: |
          set(JPEGXL_ENABLE_DOXYGEN   OFF CACHE BOOL "")
          set(JPEGXL_ENABLE_MANPAGES  OFF CACHE BOOL "")
          set(JPEGXL_ENABLE_BENCHMARK OFF CACHE BOOL "")
          set(JPEGXL_ENABLE_EXAMPLES  OFF CACHE BOOL "")
          set(JPEGXL_ENABLE_JNI       OFF CACHE BOOL "")
          set(JPEGXL_ENABLE_VIEWERS   OFF CACHE BOOL "")
          set(JPEGXL_ENABLE_PLUGINS   OFF CACHE BOOL "")
          set(JPEGXL_ENABLE_TOOLS     OFF CACHE BOOL "")
          set(JPEGXL_ENABLE_DEVTOOLS  OFF CACHE BOOL "")
          set(JPEGXL_TEST_TOOLS       OFF CACHE BOOL "")
          set(BUILD_TESTING           OFF CACHE BOOL "")
          ${{ env.TOOLCHAIN_TEXT }}
          set(CMAKE_BUILD_TYPE Release)
          set(CMAKE_INSTALL_PREFIX "${CMAKE_CURRENT_LIST_DIR}/libjxl-install" CACHE PATH "")
      run: |
        echo "${LIBJXL_CONFIG}" | tee ./libjxl-make.cmake
        cmake -S ./libjxl.git -B ./libjxl-make -G Ninja -D CMAKE_TOOLCHAIN_FILE="$PWD/libjxl-make.cmake"
    - name: Build project
      if: steps.cache.outputs.cache-hit != 'true'
      run: cmake --build ./libjxl-make
    - name: Install build
      if: steps.cache.outputs.cache-hit != 'true'
      run: |
        cmake --install ./libjxl-make --prefix ./libjxl-install
        cp -f "./libjxl.git/LICENSE"   "./libjxl-install/"
        cp -f "./libjxl.git/README.md" "./libjxl-install/"
    - name: Upload build
      uses: actions/upload-artifact@v4
      with:
        name: libjxl-windows-x64-mingw
        path: libjxl-install
        if-no-files-found: error

  build-lin-mingw-dav1d:
    runs-on: ubuntu-24.04
    steps:
    - uses: actions/cache@v5
      id: cache
      with:
        path: dav1d-install
        key: dav1d-windows-x64-mingw-${{ env.DAV1_REF }}-${{ env.CACHE_REV }}
    - name: Clone Tree
      if: steps.cache.outputs.cache-hit != 'true'
      uses: actions/checkout@v6
      with:
        path: dav1d.git
        repository: videolan/dav1d
        ref: ${{ env.DAV1_REF }}
        fetch-depth: 1
    - name: Install Dependencies
      if: steps.cache.outputs.cache-hit != 'true'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          g++ nasm meson ninja-build \
          mingw-w64-common mingw-w64-tools binutils-mingw-w64-x86-64 \
          g++-mingw-w64-x86-64-posix gcc-mingw-w64-x86-64-posix
        ${TOOLCHAIN_PREFIX}-g++ --version
    - name: Configure project
      if: steps.cache.outputs.cache-hit != 'true'
      run: |
        meson setup \
          --cross-file=$PWD/dav1d.git/package/crossfiles/${TOOLCHAIN_PREFIX}.meson \
          --prefix=$PWD/dav1d-install \
          --default-library=static \
          ./dav1d-make ./dav1d.git
    - name: Build project
      if: steps.cache.outputs.cache-hit != 'true'
      run: ninja -C ./dav1d-make
    - name: Install project
      if: steps.cache.outputs.cache-hit != 'true'
      run: ninja -C ./dav1d-make install
    - name: Upload build
      uses: actions/upload-artifact@v4
      with:
        name: dav1d-windows-x64-mingw
        path: dav1d-install
        if-no-files-found: error

  build-lin-mingw-ffmpeg:
    runs-on: ubuntu-24.04
    needs: [build-lin-mingw-libjxl, build-lin-mingw-dav1d]
    steps:
    - uses: actions/cache@v5
      id: cache
      with:
        path: ffmpeg-install
        key: ffmpeg-windows-x64-mingw-${{ env.FFMPEG_REF }}-${{ env.CACHE_REV }}
    - name: Clone Tree
      if: steps.cache.outputs.cache-hit != 'true'
      uses: actions/checkout@v6
      with:
        path: ffmpeg.git
        repository: FFmpeg/FFmpeg
        ref: ${{ env.FFMPEG_REF }}
        fetch-depth: 1
    #- name: Clone Tree
    #  uses: actions/checkout@v6
    #  with:
    #    path: bzip2.git
    #    repository: https://gitlab.com/bzip2/bzip2.git
    #    ref: 'bzip2-1.0.8'
    #    fetch-depth: 1
    - name: Clone openjpeg
      if: steps.cache.outputs.cache-hit != 'true'
      uses: actions/checkout@v6
      with:
        path: openjpeg.git
        repository: uclouvain/openjpeg
        ref: ${{ env.OPENJPEG_REF }}
        fetch-depth: 1
    - name: Download dav1d build
      if: steps.cache.outputs.cache-hit != 'true'
      uses: actions/download-artifact@v5
      with:
        name: dav1d-windows-x64-mingw
        path: dav1d-install
    - name: Download libjxl build
      if: steps.cache.outputs.cache-hit != 'true'
      uses: actions/download-artifact@v5
      with:
        name: libjxl-windows-x64-mingw
        path: libjxl-install
    - name: Install Dependencies
      if: steps.cache.outputs.cache-hit != 'true'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          g++ nasm cmake libz-mingw-w64-dev \
          mingw-w64-common mingw-w64-tools binutils-mingw-w64-x86-64 \
          g++-mingw-w64-x86-64-posix gcc-mingw-w64-x86-64-posix
        ${TOOLCHAIN_PREFIX}-g++ --version
    #- name: Build bzip2
    #  if: steps.cache.outputs.cache-hit != 'true'
    #  run: |
    #    #aNbJobs="$(getconf _NPROCESSORS_ONLN)"
    #    #pushd bzip2.git
    #    #make libbz2.a -j$aNbJobs CC=${TOOLCHAIN_PREFIX}-gcc AR=${TOOLCHAIN_PREFIX}-ar RANLIB=${TOOLCHAIN_PREFIX}-ranlib
    #    #cp -f "$aLibRoot/libbz2.a" "$OUTPUT_FOLDER/lib"
    #    #popd
    #    cmake -S ./bzip2.git -B ./bzip2-make -G Ninja \
    #      -D CMAKE_TOOLCHAIN_FILE="$PWD/${TOOLCHAIN_PREFIX}.cmake" \
    #      -D CMAKE_BUILD_TYPE=Release \
    #      -D CMAKE_INSTALL_PREFIX:PATH="$PWD/bzip2-install"
    - name: Configure openjpeg
      if: steps.cache.outputs.cache-hit != 'true'
      env:
        OPENJPEG_CONFIG: |
          set(BUILD_SHARED_LIBS OFF CACHE BOOL "")
          ${{ env.TOOLCHAIN_TEXT }}
          set(CMAKE_BUILD_TYPE Release)
          set(CMAKE_INSTALL_PREFIX "${CMAKE_CURRENT_LIST_DIR}/openjpeg-install" CACHE PATH "")
      run: |
        echo "${OPENJPEG_CONFIG}" | tee ./openjpeg-make.cmake
        cmake -S ./openjpeg.git -B ./openjpeg-make -G Ninja -D CMAKE_TOOLCHAIN_FILE="$PWD/openjpeg-make.cmake"
    - name: Build openjpeg
      if: steps.cache.outputs.cache-hit != 'true'
      run: cmake --build ./openjpeg-make
    - name: Install openjpeg
      if: steps.cache.outputs.cache-hit != 'true'
      run: cmake --install ./openjpeg-make --prefix ./openjpeg-install
    - name: Configure FFmpeg
      if: steps.cache.outputs.cache-hit != 'true'
      run: |
        export PKG_CONFIG_LIBDIR=
        export PKG_CONFIG_PATH=/usr/${TOOLCHAIN_PREFIX}/lib/pkgconfig:$PWD/dav1d-install/lib/pkgconfig:$PWD/openjpeg-install/lib/pkgconfig:$PWD/libjxl-install/lib/pkgconfig
        anFFmpegInstall=$PWD/ffmpeg-install
        # redirect error state from tee
        set -o pipefail
        pushd ./ffmpeg.git
        # --enable-hardcoded-tables - build fails on 8.0.1
        # --enable-libdav1d --enable-libopenjpeg --enable-gpl --enable-avisynth
        ./configure \
          --prefix=$anFFmpegInstall \
          --enable-cross-compile --target-os=mingw32 --cross-prefix=${TOOLCHAIN_PREFIX}- --arch=x86_64 \
          --extra-ldflags=-static-libgcc \
          --disable-debug --disable-stripping \
          --disable-doc \
          --extra-version=sView.ru \
          --enable-version3 \
          --enable-swscale --enable-avfilter \
          --enable-shared --disable-static \
          --enable-pthreads --disable-w32threads \
          --enable-runtime-cpudetect \
          --enable-libdav1d --enable-libopenjpeg --enable-libjxl \
          2>&1 | tee ../ffmpeg-config.log
        popd
    - name: Build FFmpeg
      if: steps.cache.outputs.cache-hit != 'true'
      run: |
        pushd ./ffmpeg.git
        aNbJobs="$(getconf _NPROCESSORS_ONLN)"
        make -j $aNbJobs
        popd
    - name: Install FFmpeg
      if: steps.cache.outputs.cache-hit != 'true'
      run: |
        pushd ./ffmpeg.git
        make install
        popd
        cp -f ./ffmpeg-config.log           ./ffmpeg-install/
        cp -f ./ffmpeg.git/Changelog        ./ffmpeg-install/
        cp -f ./ffmpeg.git/README.md        ./ffmpeg-install/
        cp -f ./ffmpeg.git/LICENSE.md       ./ffmpeg-install/
        cp -f ./ffmpeg.git/COPYING.LGPLv2.1 ./ffmpeg-install/
        cp -f ./ffmpeg.git/COPYING.LGPLv3   ./ffmpeg-install/
        # copy dependencies
        cp -f ./libjxl-install/bin/*.dll                       ./ffmpeg-install/bin/
        cp -f /usr/${TOOLCHAIN_PREFIX}/lib/libwinpthread-1.dll ./ffmpeg-install/bin/
        cp -f /usr/${TOOLCHAIN_PREFIX}/lib/zlib1.dll           ./ffmpeg-install/bin/
    - name: Upload build
      uses: actions/upload-artifact@v4
      with:
        name: ffmpeg-windows-x64-mingw
        path: ffmpeg-install
        if-no-files-found: error

  build-lin-mingw-sview:
    runs-on: ubuntu-24.04
    needs: [build-lin-mingw-freetype, build-lin-mingw-openal, build-lin-mingw-openvr, build-lin-mingw-ffmpeg]
    steps:
    - name: Clone Tree
      uses: actions/checkout@v6
      with:
        path: sview.git
        fetch-depth: 1
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          g++ cmake ninja-build libz-mingw-w64-dev \
          mingw-w64-common mingw-w64-tools binutils-mingw-w64-x86-64 \
          g++-mingw-w64-x86-64-posix gcc-mingw-w64-x86-64-posix
        ${TOOLCHAIN_PREFIX}-g++ --version
    - name: Download FreeType build
      uses: actions/download-artifact@v5
      with:
        name: freetype-windows-x64-mingw
        path: freetype-install
    - name: Download OpenAL soft build
      uses: actions/download-artifact@v5
      with:
        name: openal-windows-x64-mingw
        path: openal-install
    - name: Download OpenVR build
      uses: actions/download-artifact@v5
      with:
        name: openvr-windows-x64-mingw
        path: openvr-install
    - name: Download FFmpeg build
      uses: actions/download-artifact@v5
      with:
        name: ffmpeg-windows-x64-mingw
        path: ffmpeg-install
    - name: Configure project
      env:
        SVIEW_CONFIG: |
          set(USE_OPENVR ON  CACHE BOOL "")
          ${{ env.TOOLCHAIN_TEXT }}
          set(CMAKE_BUILD_TYPE Release)
          set(CMAKE_INSTALL_PREFIX "${CMAKE_CURRENT_LIST_DIR}/sview-install"    CACHE PATH "")
          set(FREETYPE_DIR         "${CMAKE_CURRENT_LIST_DIR}/freetype-install" CACHE PATH "")
          set(FFMPEG_DIR           "${CMAKE_CURRENT_LIST_DIR}/ffmpeg-install"   CACHE PATH "")
          set(OPENAL_DIR           "${CMAKE_CURRENT_LIST_DIR}/openal-install"   CACHE PATH "")
          set(OPENVR_DIR           "${CMAKE_CURRENT_LIST_DIR}/openvr-install"   CACHE PATH "")
      run: |
        export PKG_CONFIG_LIBDIR=
        export PKG_CONFIG_PATH=/usr/${TOOLCHAIN_PREFIX}/lib/pkgconfig:$PWD/ffmpeg-install/lib/pkgconfig:$PWD/freetype-install/lib/pkgconfig
        echo "${SVIEW_CONFIG}" | tee ./sview-make.cmake
        cmake -S ./sview.git -B ./sview-make -G Ninja -D CMAKE_TOOLCHAIN_FILE="$PWD/sview-make.cmake"
    - name: Build project
      run: cmake --build ./sview-make
    - name: Install build
      run: |
        cmake --install ./sview-make --prefix ./sview-install
        cp -f ./freetype-install/bin/*.dll ./sview-install/
        cp -f ./ffmpeg-install/bin/*.dll   ./sview-install/
        cp -f ./openal-install/bin/*.dll   ./sview-install/
        #cp -f ./openvr-install/bin/*.dll   ./sview-install/
        cp -f /usr/lib/gcc/${TOOLCHAIN_PREFIX}/13-posix/libstdc++-*.dll    ./sview-install/
        cp -f /usr/lib/gcc/${TOOLCHAIN_PREFIX}/13-posix/libgcc_s_seh-*.dll ./sview-install/
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: sview-windows-x64-mingw
        path: ./sview-install
        if-no-files-found: error
